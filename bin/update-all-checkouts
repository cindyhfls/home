#!/bin/sh

# Find alllllll the repositories within my homedir and note their status.
#
# Technically, we only find the svn checkouts in my standard checkout areas
# because it's more work to identify the "root" of any particular svn
# checkout.

# TODO: add nice colors to svn status, maybe from
# http://snipplr.com/view/28748/colorcoded-svn-status-v3/

if nm-tool 2>/dev/null | grep -q '^State: connected'; then
    # Unset this to avoid connecting to upstream servers.
    online=1
    echo "Online; will fetch updates."
fi

find ~/var/local/ ~/mnt/ -name '*.git' | while read dir
do (
    dir_vis=$(
        tput setaf 5
        tput bold
        echo -n "~${dir#$HOME}"
        tput sgr0
        )

	cd "$dir"
	cd ..
	echo -n ". $dir_vis"
    tput cr
	if [ "$online" -a -e .git/refs/remotes/origin ]; then
        git fetch -q --all
		curr_branch=$(git symbolic-ref -q --short HEAD)
		upstream=$(git config "branch.$curr_branch.merge")
		remote=$(git config "branch.$curr_branch.remote")
		if [ "$upstream" -a "$remote" ]; then
			if git merge -q --ff-only '@{u}'; then
                tput bold
                tput setaf 2
                echo "Y $dir_vis: In sync."
            else
                tput bold
                tput setaf 1
                echo "N $dir_vis: Needs update; can't automatically."
            fi
		else
            tput bold
            tput setaf 3
            echo "? $dir_vis: No tracking branch."
            echo try: git branch -u `git remote | head -1`/"$curr_branch"
		fi
	else
        tput bold
        tput setaf 3
        echo "X $dir_vis: No repo to update from."
	fi

	git status -s
	)
done

for dir in ~/var/local/*
do [ -d "$dir/.svn" ] || continue
	(
	cd "$dir"
	echo "\033[1m`pwd`\033[m"
	if [ "$online" ]; then
		svn status -u
	else
		svn status
	fi
	echo
	)
done
